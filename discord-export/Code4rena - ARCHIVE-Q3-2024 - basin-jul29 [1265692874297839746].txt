==============================================================
Guild: Code4rena
Channel: ARCHIVE-Q3-2024 / basin-jul29
==============================================================

[07/24/2024 19:24] itsmetechjay (pinned)
üëã Hello and welcome to the audit channel for the $37,750 in USDC **Basin** audit!

üìÜ Audit opens Monday, 29 July 2024 20:00 (20:00 UTC) and runs through Thursday, 08 August 2024 20:00 (20:00 UTC) (10 days).

Please give a warm welcome to the Basin team, particularly @Brean, @guy, @deadmanwalking, and @aloceros who will be available for questions either here in the channel or via a PRIVATE thread in the GMT +3 timezone. 

ü§ñ¬†**Documentation bot assistance:** For general questions about the codebase, give our documentation bot a try once the audit is live, by tagging `@Docs Wolf` in any thread (private or public) and asking your question. The bot will make its best attempt to answer based on the codebase and documentation, and link you to relevant resources.  

We'll be posting relevant links, documentation, etc. here, so if you intend to participate in this audit, consider enabling notifications for this channel. üê∫ ‚è∞

Audit Page: https://code4rena.com/audits/2024-07-basin

{Reactions}
üî• (4) 

[07/29/2024 20:29] itsmetechjay
Pinned a message.


[07/30/2024 02:46] gscoder
4 tests are failing

{Attachments}
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/image-7F0F5.png


[07/30/2024 06:22] deadmanwalking0021
gm! Which ones are failing? Have you followed all the build instructions ?


[07/30/2024 10:14] 0xsorrynotsorry
This happens when the MAINNET_RPC_URL is NOT set in .env file

{Reactions}
üíØ (2) üëç 

[07/30/2024 12:10] prapandey031
Even after setting the rpc url in foundry.toml, 3 tests fail


[07/30/2024 12:18] prapandey031
1. testFuzz_powu(uint256, uint256, uint256) in TestABDK.t.sol

2. testFuzzInstance_capReserve() in Pump.CapReserves.t.sol

3. testFuzz_capReserve_xBlock(uint256[2], uint256[2], uint256) in Pump.CapReserves.t.sol


[07/30/2024 12:51] superman_i4g
You‚Äôre to set it in your env file that you created. Follow the guidelines given in the contest page. All test passed for me.


[07/30/2024 12:52] prapandey031
You mean the env directory, right?


[07/30/2024 12:53] superman_i4g
Nope. The .env file


[07/30/2024 12:53] prapandey031
Ok. Thanks.

{Reactions}
üëç 

[07/30/2024 15:02] prapandey031
Basically, the issue was improper download of the requirements. The .env file creation is optional; just have a rpc url for the MAINNET_RPC_URL var in the toml file (either directly or through a .env file).
Make sure the requirements are downloaded and installed properly. 

All tests have passed for me.

{Reactions}
üëç (3) 

[07/30/2024 17:03] gulshn321
üòî wth is the file with 2000nsloc everything hardcoded
scared me


[07/30/2024 18:13] gulshn321
can you explain Stable2LUT1.sol briefly


[07/30/2024 18:55] seraviz
Started a thread.


[07/30/2024 19:55] deadmanwalking0021
The stable2 lookup table is a contract that allows Stable2.calcReserveAtRatioLiquidity() and Stable2.calcReserveAtRatioSwap() to efficiently retrieve initial estimations for the pool reserve ratios needed to perform operations that retrive the values of each token that can be converted or swapped in a well in order to assist in peg maintenance of the bean stablecoin. The lookup table contains if ladders generated by binary trees for each respective function. The trees were generated by performing simulations on the stableswap curve and marking the price at different points and liquidity levels. The points were then sorted by price and the tree was generated by recursively splitting the data points in halves until the final leaves were reached. In this way the most frequent prices appear at the top of the tree. The lookup table significantly reduces the gas requirements for the Stable2 functions to converge into the correct target token ratios.


[07/30/2024 19:59] gulshn321
Thanks üôè got it


[07/30/2024 20:33] brean (pinned)
Wanted to give some more insight on the development of the stable2 Well function: The function is a implementation of the curve stableswap AMM on basin. Infomation can be seen here:  
https://curve.fi/files/stableswap-paper.pdf
https://github.com/curvefi/curve-stablecoin/blob/master/contracts/Stableswap.vy 

`calcLpTokenSupply` uses the same formula as `get_D` in the stableswap.vy (given the reserves, calculate its LP token supply), and 
`calcReserve` uses the same formula as `get_y`  (given a set of reserves, the lp token supply, and index, find the reserves for that index). 

`getRatiosFromPriceLiquidity` and `getRatiosFromPriceSwap` in the lookup table allows us to get the ratio of the pool reserves given a price. Given that there is a size limit for a given contract, the function returns the ratios for the closest highest and lowest price of the input price.  


The methodology to calculate the ratios are: 

`getRatiosFromPriceLiquidity`:
Starting with a base reserve `x_0`, `y_0` 
1) increment/decrement `x_0` by some x step size
2) calculate the price using `calcRate` with the new reserves
3) repeat 1-2 for a range of x. 

`getRatiosFromPriceSwap`, 
Starting with a base reserve x_0, y_0 
0) calc the lp token supply using `calcLPTokenSupply`
1) increment/decrement `x_0` by some step size
2) calculate the y reserve using `calcReserve`
2) calculate the price using `calcRate` with the new reserves. 
3) repeat 1-3 for a range of x.

The rationale for the lookup table was that `calcReserveAtRatioLiquidity` and `calcReserveAtRatioSwap` performs a newtons estimation on chain, which the number of iterations it takes to converge is largely a function of the initial guess and step size. Thus, the lookup table  assists in finding a good value to initialize the newton estimation, which reduces the amount of iterations significantly. 

The logic used to calculate the ratios used can be found in `StableswapCalcRatiosLiqSim.s.sol` and `StableswapCalcRatiosSwapSim.s.sol`.

{Embed}
https://github.com/curvefi/curve-stablecoin/blob/master/contracts/Stableswap.vy
curve-stablecoin/contracts/Stableswap.vy at master ¬∑ curvefi/curve-...
Stablecoin powered by LLAMMAs. Contribute to curvefi/curve-stablecoin development by creating an account on GitHub.
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/curve-stablecoin-9DF7A

{Reactions}
‚ù§Ô∏è üëç (2) ü´° 

[07/30/2024 21:02] 4gontuk
@Brean kindly check PT


[07/31/2024 05:05] nmirchev8
Which chain should be supported?


[07/31/2024 05:38] deadmanwalking0021 (pinned)
All evm compatible chains are in scope but basin is deployed on eth mainnet and possibly arbitrum/base

{Reactions}
üôè 

[07/31/2024 13:09] kartoonjoy
Pinned a message.


[07/31/2024 13:13] kartoonjoy
Pinned a message.


[08/02/2024 04:44] 0xflare2684
Hey, I am facing troubble while running forge test


[08/02/2024 04:45] 0xflare2684
Has anybody else successfully run test?


[08/02/2024 08:03] nmirchev8
How functions `calcReserveAtRatioLiquidity` and `calcReserveAtRatioSwap` are going to be used? 
Right now they are not being used in `well`


[08/02/2024 08:06] brean
`calcReserveAtRatioLiquidity` and `calcReserveAtRatioSwap` are not used within the well, but are used externally. In Beanstalk's case, they are used in order to calculate the reserve at a certain ratio (through a swap, or adding liquidity).

{Reactions}
‚úÖ 

[08/02/2024 08:11] nmirchev8
Can we see an example of values that we pass for `ratios` param? Do we use the same as `reserves`?


[08/02/2024 08:14] brean (pinned)
Yes, here is an example of where `calcReserveAtRatioSwap` is being used within Beanstalk.
https://github.com/BeanstalkFarms/Beanstalk/blob/master/protocol/contracts/libraries/Minting/LibWellMinting.sol#L195

Here is an example for `calcReserveAtRatioLiquidity`:
https://github.com/BeanstalkFarms/Beanstalk/blob/master/protocol/contracts/libraries/Convert/LibWellConvert.sol#L46

{Embed}
https://github.com/BeanstalkFarms/Beanstalk/blob/master/protocol/contracts/libraries/Minting/LibWellMinting.sol
Beanstalk/protocol/contracts/libraries/Minting/LibWellMinting.sol a...
A monorepo for the Beanstalk protocol, SDK, subgraphs and UI. Currently houses infra for the Basin protocol. - BeanstalkFarms/Beanstalk
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/Beanstalk-BC9BA

{Embed}
https://github.com/BeanstalkFarms/Beanstalk/blob/master/protocol/contracts/libraries/Convert/LibWellConvert.sol
Beanstalk/protocol/contracts/libraries/Convert/LibWellConvert.sol a...
A monorepo for the Beanstalk protocol, SDK, subgraphs and UI. Currently houses infra for the Basin protocol. - BeanstalkFarms/Beanstalk
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/Beanstalk-BC9BA

{Reactions}
üôè (2) 

[08/02/2024 09:49] kartoonjoy
Pinned a message.


[08/02/2024 14:19] vikqaz
@deadmanwalking Why are we using --ffi flag with forge test commands? why are we using foreign function interface?


[08/02/2024 14:30] deadmanwalking0021
Because some tests require a python script to be run inline, so ffi is needed for these to succeed. For example see `Pump.CapReserves.t.sol` : https://github.com/BeanstalkFarms/Basin/blob/58ca5971061d7a02fa0fab3ee16297391bcb97e8/test/pumps/Pump.CapReserves.t.sol#L237

{Embed}
https://github.com/BeanstalkFarms/Basin/blob/58ca5971061d7a02fa0fab3ee16297391bcb97e8/test/pumps/Pump.CapReserves.t.sol
Basin/test/pumps/Pump.CapReserves.t.sol at 58ca5971061d7a02fa0fab3e...
A composable EVM-native decentralized exchange protocol. - BeanstalkFarms/Basin

{Reactions}
üëç ü´° 

[08/02/2024 14:56] calfun0x
Hi, i have tests running ok after adding  a .env file with a MAINNET_RPC_URL url from infura


[08/02/2024 15:17] brean
Additionally, the ffi tests are mainly with the pump. Stable2 and Well Upgradeable tests do not need to use ffi, if you don't feel comfortable with using the flag.

{Reactions}
üôåüèª 

[08/02/2024 15:52] 0xflare2684
I have set everything , but facing error while forge test


[08/02/2024 16:45] calfun0x
Started a thread.


[08/04/2024 12:36] vikqaz
@deadmanwalking @Brean can you please provide link to Developer Docs/Technical Reference Docs?


[08/05/2024 08:51] fastchecker_27
pls explain about this formula and give me relative docs

{Attachments}
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/image-64AA5.png


[08/05/2024 10:39] brean
this is the stableSwap invariant defined by curve: 
https://berkeley-defi.github.io/assets/material/StableSwap.pdf 

The solution was designed for N tokens, but this current stableswap implementation only uses 2 token, which allows for some simplification.


[08/05/2024 16:03] 0xbrett8571
Started a thread.


[08/05/2024 17:00] brean
For those asking how to derive the equations, these are the same derivations seen in the curve contracts. Here's a article on how someone came to the derivation here üôÇ :
https://atulagarwal.dev/posts/curveamm/stableswap/

{Embed}
https://atulagarwal.dev/posts/curveamm/stableswap/
Understanding the Curve AMM, Part -1: StableSwap Invariant
Curve StableSwap Invariant


[08/07/2024 10:35] 0xrochimaru
The nSLOC doesn't match with the files. Am I missing something? How does `src/interfaces/ILookupTable.sol` has 2150 lines of code


[08/07/2024 10:53] deadmanwalking0021
This refers to `Stable2LUT1.sol` no the interface. On the website it just mentions that the LUT implements the interface.

{Reactions}
‚úÖ 

[08/07/2024 15:41] vikqaz
@deadmanwalking The flow of the tx to the ultimate well implementation contract is routed via 2 proxies? first from minimal proxy (clone) and then from UUPS proxy to the actual implementation?


[08/07/2024 15:43] vikqaz
@deadmanwalking I mean in the clone (bored Well by Aquifer), the address of the implementation (embedded in the bytecode of minimal proxy) is the address of UUPS proxy?


[08/07/2024 16:24] deadmanwalking0021
Correct. Its a chain of proxies so 2 delegatecalls!

{Reactions}
üëçüèª 

[08/08/2024 12:45] vikqaz
@deadmanwalking in scripts, the deployment script of WellUpgradeable is not written yet?


[08/08/2024 14:09] deadmanwalking0021
Correct. You can check the tests at `WellUpgradeable.t.sol` for an example of how to deploy an upgradeable well.

{Reactions}
ü´° 

[08/08/2024 15:15] lavizrap_
@deadmanwalking  @Brean  what is the difference between ratios and reserves in the context of `getScaledReserves`?


[08/08/2024 16:12] nmirchev8
Ratio is price ratio


[08/08/2024 16:59] lavizrap_
so ratio[0] = reserve[0]/reserve[1]?


[08/08/2024 17:09] nmirchev8
The function calculates what the reserves should look like, if we want the stable swap function to behave for those ratios

Check the above resources.
Curve invariant is different from uniswap formula

{Reactions}
üëç 

[08/08/2024 20:02] C4
**üö® AUDIT ALERT**

@üê∫Wardens The **Basin** audit is now closed! Huge thanks to everyone who participated üîç, whether you submitted a finding or not.

What's next: The sponsor team and judge will review the findings over the next couple of weeks. Feel free to ping a Civics-Admin if you have questions along the way!


[08/08/2024 20:10] 4gontuk
133 Submissions üëÄ


[08/09/2024 05:41] rio_1101
I thought it would be more üëÄ


[08/12/2024 16:41] rio_1101
https://tenor.com/view/gjirlfriend-gif-14457952604098199169

{Embed}
https://tenor.com/view/gjirlfriend-gif-14457952604098199169
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/gjirlfriend-729B5.png


[08/14/2024 07:01] vikqaz
Hey @deadmanwalking will you guys still respond here?


[08/14/2024 07:01] vikqaz
I was doing some stuff with the codebase, need to ask something


[08/14/2024 07:02] vikqaz


{Attachments}
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/Screenshot_2024-08-14_at_12.01.40_PM-19370.png


[08/14/2024 07:03] vikqaz
@deadmanwalking you actually endorsed both of these statements, where as both of these are not correct bro. üôÇ


[08/14/2024 07:04] vikqaz
@deadmanwalking


[08/14/2024 07:12] deadmanwalking0021
The flow is ERC1967 Proxy -> Well minimal Proxy ->well implementation. I am not sure what you re reffering to here


[08/14/2024 07:12] vikqaz
let me tag again, bytheway thanks for responding bro


[08/14/2024 07:13] vikqaz
this one bro


[08/14/2024 07:13] vikqaz
Yup this is the correct flow now I can see in the bytecodes of the deployed contracts


[08/14/2024 07:14] vikqaz
Because of this confusion, I was not able to write the PoC. hahahah bette luck next time.


[08/14/2024 07:15] vikqaz


{Attachments}
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/Screenshot_2024-08-14_at_12.15.01_PM-1D17E.png


[08/14/2024 07:15] vikqaz
@deadmanwalking are you guys going to launch some bug bounty program?


[08/14/2024 07:18] deadmanwalking0021
The basin bug bounty program on immunify is convered under Beanstalk here: https://immunefi.com/bug-bounty/beanstalk/information/


[08/14/2024 07:19] vikqaz
ahhhh great man.... Thanks.


[08/14/2024 07:19] vikqaz
again thank you so much for responding after that late time


[08/19/2024 08:24] honour_d_dev


{Attachments}
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/gjirlfriend-A5592.mp4


[08/19/2024 12:44] artur9905
@Honour  I see that you are with the SR role, can you see something more, like is the judge close to ending with the submissions?


[08/19/2024 12:55] honour_d_dev
I think it is , should not exceed this week though


[08/20/2024 23:58] jacobmartin0406
wen PJQA? ü§î


[08/21/2024 15:36] 0xpopeye
Has started

{Reactions}
üôè 

[08/27/2024 16:05] 0xaadhi
Result out Today?

{Reactions}
üî• 

[08/27/2024 20:43] liveactionllamac4
ü§ë üéâ  Awards for **Basin**:

$19,171.69 USDC ¬ª Egis_Security (@nmirchev8 and @deth) 
$1,043.93 USDC ¬ª @ZanyBonzy 
$772.57 USDC ¬ª @zanderbyte 
$731.92 USDC ¬ª @Flare 
$731.92 USDC ¬ª @Honour 
$472.65 USDC ¬ª @Rhaydden 
$214.75 USDC ¬ª @0xAadi 
$135.48 USDC ¬ª @0x11singh99 
$135.48 USDC ¬ª @0xSecuri 
$135.48 USDC ¬ª @Walter 
$135.48 USDC ¬ª @debo 
$135.48 USDC ¬ª @mgf15 
$135.48 USDC ¬ª @shaflow2 
$135.48 USDC ¬ª @chaosSR 
$76.18 USDC ¬ª @Mrxstrange 
$67.74 USDC ¬ª @John_Femi 
$67.74 USDC ¬ª @NoOne 
$42.31 USDC ¬ª @oxait 
$8.44 USDC ¬ª @0xRiO 
$8.44 USDC ¬ª @Agontuk 
$8.44 USDC ¬ª @Akay 
$8.44 USDC ¬ª @Bauchibred 
$8.44 USDC ¬ª @FastChecker 
$8.44 USDC ¬ª @KupiaSec 
$8.44 USDC ¬ª @Nikki 
$8.44 USDC ¬ª @SAQ 
$8.44 USDC ¬ª @The Fabled 
$8.44 USDC ¬ª @alexzoid 
$8.44 USDC ¬ª @d4r3d3v1l 
$8.44 USDC ¬ª @JTB 
$8.44 USDC ¬ª @macart224 
$8.44 USDC ¬ª @psb01 
$8.44 USDC ¬ª @Rare_one 
$8.44 USDC ¬ª @0xStuart 
$8.44 USDC ¬ª @trachev 
$8.44 USDC ¬ª @WillyCode20 
$2.11 USDC ¬ª @0xdanielc 
$2.11 USDC ¬ª @ArcaneAgent 
$2.11 USDC ¬ª @Alex Zhang

üèÅ Findings summary
--------------------------------------‚Äî
2 High risk findings
2 Med risk findings
60 wardens contributed

Top Hunter: Egis\_Security
Top Gatherers: ZanyBonzy, Flare, Honour, and zanderbyte
Top QA report: Rhaydden

Awards will be distributed on Polygon. Congratulations all!  üí∏ üí∏ üí∏

‚ö†Ô∏è Awardees, be sure to review [this announcement](https://discord.com/channels/810916927919620096/810929015509483554/1272625452909072415) and fill in your tax info if you haven't already. This must be completed within 30 days (i.e. before Friday, 27 September 2024) to receive your award distribution for this audit.

*Note: If you participated in this audit and don‚Äôt see your name on this list, please wait until the report is published and the findings repo is made public to check on your submissions.*

{Reactions}
üî• (5) EgisSec (4) 

[08/27/2024 21:20] shealtielanz
Congrats @WillyCode20 üî•üòù on your first win üèÖ ever on c4
Can‚Äôt wait to see u climb to the top

{Reactions}
üî• (2) 

[08/27/2024 22:54] 0xnevi
@nmirchev8 @deth Congrats chads üôÇ

{Reactions}
üî• (4) 

[08/28/2024 03:57] mgf15
https://tenor.com/view/i-am-back-estoy-de-vuelta-toy-story2-gif-26436333

{Embed}
https://tenor.com/view/i-am-back-estoy-de-vuelta-toy-story2-gif-26436333
Code4rena - ARCHIVE-Q3-2024 - basin-jul29 [1265692874297839746].txt_Files/i-am-back-estoy-de-vuelta-721B0.png

{Reactions}
andbang 

[08/28/2024 05:41] nmirchev8
Thanks, m8


[08/28/2024 08:59] deth2814
Thanks bro üí™


[08/28/2024 23:19] willycode20
Thanks man


[09/02/2024 10:05] 0x11singh99
when rewards will be sent ?

{Reactions}
üëÄ (6) üòî 

[09/11/2024 01:18] itsmetechjay
‚ÑπÔ∏è This channel is pending archive.   As a result, any private threads will be permanently deleted on Tuesday, 01 October 2024.  Please make sure to grab anything you might need before then.


[09/14/2024 15:18] saq_143
Reward?üòî


[09/16/2024 06:31] 0x11singh99
Why rewards are getting so late this time ?


[09/16/2024 08:25] unnamedeth.lens
Already received

{Reactions}
üëç 

[09/16/2024 09:29] 0x11singh99
ohh my bad I was just looking c4-updates channel.


[09/16/2024 12:32] unnamedeth.lens
np
congrats btw üôè

{Reactions}
‚ù§Ô∏è 

[09/18/2024 09:01] saq_143
In which network they are sent reward?


[09/18/2024 13:07] unnamedeth.lens
polygon

{Reactions}
üëç 

[09/18/2024 14:00] saq_143
Ok
But I have not received the reward yet


[09/18/2024 14:03] unnamedeth.lens
contact the team and make sure to confrm the tax info before

{Reactions}
üëÜ üíØ 

[09/18/2024 14:03] thebrittfactor
We'll need tax info by Sept 27th in order to receive awards.

{Reactions}
üëç 

[09/30/2024 13:37] itsmetechjay
‚ÑπÔ∏è Reminder: this channel will be deleted after 24 hours.


==============================================================
Exported 97 message(s)
==============================================================
